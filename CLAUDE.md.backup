# CLAUDE.md - GuÃ­a Completa del Proyecto NewProject

Este archivo es la **guÃ­a definitiva** para trabajar en este proyecto. Contiene todas las reglas, convenciones, arquitectura y patrones que DEBEN seguirse.

---

## ÃNDICE

1. [Tech Stack](#1-tech-stack)
2. [Arquitectura General](#2-arquitectura-general)
3. [Estructura del Proyecto](#3-estructura-del-proyecto)
4. [MÃ³dulos y Features](#4-mÃ³dulos-y-features)
5. [Route Groups en App Router](#5-route-groups-en-app-router)
6. [Reglas CrÃ­ticas](#6-reglas-crÃ­ticas)
7. [Server Components First](#7-server-components-first)
8. [Server Actions](#8-server-actions)
9. [ComunicaciÃ³n entre MÃ³dulos](#9-comunicaciÃ³n-entre-mÃ³dulos)
10. [Fetching con React Query](#10-fetching-con-react-query)
11. [Sistema de Permisos](#11-sistema-de-permisos)
12. [Componentes UI y shadcn](#12-componentes-ui-y-shadcn)
13. [Formularios](#13-formularios)
14. [Base de Datos con Prisma](#14-base-de-datos-con-prisma)
15. [Nomenclaturas y Convenciones](#15-nomenclaturas-y-convenciones)
16. [Logger y Debugging](#16-logger-y-debugging)
17. [Comandos Disponibles](#17-comandos-disponibles)
18. [Checklists](#18-checklists)
19. [Testing con Cypress](#19-testing-con-cypress)
20. [Storage (MinIO/R2)](#20-storage-minior2)

---

## 1. TECH STACK

```
Framework:        Next.js 16.1.3 + React 19 (App Router, Server Components)
Base de Datos:    PostgreSQL + Prisma ORM 7
Estado Global:    Zustand (global) + Jotai (atÃ³mico)
Estado Servidor:  React Query (TanStack Query v5)
UI:               shadcn/ui + Tailwind CSS v4 + Lucide Icons
Formularios:      React Hook Form + Zod (validaciÃ³n)
AutenticaciÃ³n:    Clerk
Storage:          MinIO (dev) / Cloudflare R2 (prod) - API S3
Fechas:           moment.js (NUNCA date-fns)
Notificaciones:   Sonner
```

### Versiones Clave
- Node.js: 18+ (recomendado 20+)
- Next.js: 16.1.3
- React: 19.2.3
- TypeScript: 5+
- Prisma: 7.2.0 (con adapter @prisma/adapter-pg)

---

## 2. ARQUITECTURA GENERAL

### Concepto: MÃ³dulos con Features

La arquitectura separa claramente:

- **MÃ³dulos (`modules/`)**: Dominios de negocio completos con lÃ³gica CRUD, server actions y tipos
- **Features**: Sub-funcionalidades dentro de cada mÃ³dulo (pÃ¡ginas, vistas, formularios)
- **Shared (`shared/`)**: CÃ³digo reutilizable entre mÃ³dulos (UI, hooks, utils, lib)
- **App (`app/`)**: Solo routing con Route Groups - pÃ¡ginas DELGADAS

### Diagrama de Arquitectura

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         src/app/                                â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚   â”‚   (auth)/   â”‚  â”‚   (core)/   â”‚  â”‚    api/     â”‚            â”‚
â”‚   â”‚  sign-in    â”‚  â”‚  dashboard  â”‚  â”‚  storage    â”‚            â”‚
â”‚   â”‚  sign-up    â”‚  â”‚  employees  â”‚  â”‚             â”‚            â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  company    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                    â”‚  teams...   â”‚                              â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚   PÃGINAS DELGADAS - Solo importan de modules/                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       src/modules/                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚ dashboard â”‚ â”‚ employees â”‚ â”‚  company  â”‚ â”‚   teams   â”‚      â”‚
â”‚   â”‚ features/ â”‚ â”‚ features/ â”‚ â”‚ features/ â”‚ â”‚ features/ â”‚      â”‚
â”‚   â”‚ actions   â”‚ â”‚ actions   â”‚ â”‚ actions   â”‚ â”‚ actions   â”‚      â”‚
â”‚   â”‚ types     â”‚ â”‚ types     â”‚ â”‚ types     â”‚ â”‚ types     â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚   LÃ“GICA DE NEGOCIO - Server Actions, Componentes, Features    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        src/shared/                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚   â”‚ components/  â”‚ â”‚   hooks/     â”‚ â”‚    lib/      â”‚           â”‚
â”‚   â”‚  ui/         â”‚ â”‚ useGeography â”‚ â”‚  prisma.ts   â”‚           â”‚
â”‚   â”‚  layout/     â”‚ â”‚ use-mobile   â”‚ â”‚  logger.ts   â”‚           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  utils.ts    â”‚           â”‚
â”‚                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚   CÃ“DIGO COMPARTIDO - Usado por todos los mÃ³dulos              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. ESTRUCTURA DEL PROYECTO

```
newproject/
â”œâ”€â”€ prisma/
â”‚   â””â”€â”€ schema.prisma              # Esquema de base de datos
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app/                       # ğŸ”¥ ROUTING (Route Groups)
â”‚   â”‚   â”œâ”€â”€ (auth)/                # Grupo: AutenticaciÃ³n (pÃºblico)
â”‚   â”‚   â”‚   â”œâ”€â”€ sign-in/[[...sign-in]]/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”‚   â”‚   â””â”€â”€ sign-up/[[...sign-up]]/
â”‚   â”‚   â”‚       â””â”€â”€ page.tsx
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ (core)/                # Grupo: App Principal (protegido)
â”‚   â”‚   â”‚   â””â”€â”€ dashboard/         # ğŸ”¥ Prefijo /dashboard para toda la app
â”‚   â”‚   â”‚       â”œâ”€â”€ layout.tsx     # Layout con Sidebar/Header
â”‚   â”‚   â”‚       â”œâ”€â”€ page.tsx       # /dashboard (home)
â”‚   â”‚   â”‚       â”œâ”€â”€ employees/     # /dashboard/employees
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ page.tsx   # â†’ modules/employees (list)
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ new/
â”‚   â”‚   â”‚       â”‚   â”‚   â””â”€â”€ page.tsx # â†’ modules/employees (create)
â”‚   â”‚   â”‚       â”‚   â””â”€â”€ [id]/
â”‚   â”‚   â”‚       â”‚       â”œâ”€â”€ page.tsx # â†’ modules/employees (detail)
â”‚   â”‚   â”‚       â”‚       â””â”€â”€ edit/
â”‚   â”‚   â”‚       â”‚           â””â”€â”€ page.tsx # â†’ modules/employees (edit)
â”‚   â”‚   â”‚       â”œâ”€â”€ companies/     # /dashboard/companies
â”‚   â”‚   â”‚       â”œâ”€â”€ equipment/     # /dashboard/equipment
â”‚   â”‚   â”‚       â””â”€â”€ company/       # /dashboard/company (configuraciÃ³n)
â”‚   â”‚   â”‚           â”œâ”€â”€ unions/    # /dashboard/company/unions
â”‚   â”‚   â”‚           â”œâ”€â”€ job-positions/
â”‚   â”‚   â”‚           â”œâ”€â”€ job-categories/
â”‚   â”‚   â”‚           â”œâ”€â”€ cost-centers/
â”‚   â”‚   â”‚           â”œâ”€â”€ contract-types/
â”‚   â”‚   â”‚           â”œâ”€â”€ collective-agreements/
â”‚   â”‚   â”‚           â”œâ”€â”€ contractors/
â”‚   â”‚   â”‚           â”œâ”€â”€ sectors/
â”‚   â”‚   â”‚           â”œâ”€â”€ type-operatives/
â”‚   â”‚   â”‚           â”œâ”€â”€ vehicle-brands/
â”‚   â”‚   â”‚           â””â”€â”€ vehicle-types/
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ api/                   # API Routes
â”‚   â”‚   â”‚   â””â”€â”€ storage/[...path]/
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ layout.tsx             # Layout raÃ­z
â”‚   â”‚   â”œâ”€â”€ page.tsx               # Landing/Redirect
â”‚   â”‚   â””â”€â”€ globals.css            # Estilos globales
â”‚   â”‚
â”‚   â”œâ”€â”€ modules/                   # ğŸ”¥ DOMINIOS DE NEGOCIO
â”‚   â”‚   â”œâ”€â”€ dashboard/
â”‚   â”‚   â”‚   â”œâ”€â”€ features/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ overview/
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ DashboardOverview.tsx
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ components/
â”‚   â”‚   â”‚   â”œâ”€â”€ actions.server.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ types.ts
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ employees/
â”‚   â”‚   â”‚   â”œâ”€â”€ features/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ list/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ EmployeesList.tsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ _EmployeesTable.tsx
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ detail/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ EmployeeDetail.tsx
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ create/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ EmployeeCreate.tsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ _EmployeeForm.tsx
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ edit/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ EmployeeEdit.tsx
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ charts/
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ index.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ actions.server.ts  # ğŸ”¥ Server Actions del mÃ³dulo
â”‚   â”‚   â”‚   â”œâ”€â”€ types.ts           # Tipos del mÃ³dulo
â”‚   â”‚   â”‚   â”œâ”€â”€ hooks/             # Hooks especÃ­ficos del mÃ³dulo
â”‚   â”‚   â”‚   â””â”€â”€ index.ts           # Barrel export
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ teams/
â”‚   â”‚   â”‚   â”œâ”€â”€ features/
â”‚   â”‚   â”‚   â”œâ”€â”€ actions.server.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ types.ts
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ documents/
â”‚   â”‚   â”‚   â”œâ”€â”€ features/
â”‚   â”‚   â”‚   â”œâ”€â”€ actions.server.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ types.ts
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ commercial/
â”‚   â”‚   â”‚   â”œâ”€â”€ features/
â”‚   â”‚   â”‚   â”œâ”€â”€ actions.server.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ types.ts
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ operations/
â”‚   â”‚   â”‚   â”œâ”€â”€ features/
â”‚   â”‚   â”‚   â”œâ”€â”€ actions.server.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ types.ts
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ maintenance/
â”‚   â”‚   â”‚   â”œâ”€â”€ features/
â”‚   â”‚   â”‚   â”œâ”€â”€ actions.server.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ types.ts
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ company/               # MÃ³dulo Empresa
â”‚   â”‚       â”œâ”€â”€ features/
â”‚   â”‚       â”‚   â”œâ”€â”€ overview/      # Vista principal de empresa
â”‚   â”‚       â”‚   â”œâ”€â”€ unions/        # Sindicatos
â”‚   â”‚       â”‚   â”œâ”€â”€ job-positions/ # Puestos de trabajo
â”‚   â”‚       â”‚   â”œâ”€â”€ job-categories/# CategorÃ­as
â”‚   â”‚       â”‚   â”œâ”€â”€ cost-centers/  # Centros de costo
â”‚   â”‚       â”‚   â”œâ”€â”€ contract-types/# Tipos de contrato
â”‚   â”‚       â”‚   â””â”€â”€ collective-agreements/ # Convenios colectivos
â”‚   â”‚       â”œâ”€â”€ actions.server.ts
â”‚   â”‚       â”œâ”€â”€ types.ts
â”‚   â”‚       â””â”€â”€ index.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ shared/                    # ğŸ”¥ CÃ“DIGO COMPARTIDO
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”œâ”€â”€ ui/                # shadcn/ui components
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ button.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ card.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ input.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ form.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ table.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ dialog.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ sidebar.tsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ... (otros componentes shadcn)
â”‚   â”‚   â”‚   â”‚
â”‚   â”‚   â”‚   â”œâ”€â”€ layout/            # Componentes de layout
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ _AppSidebar.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ _SiteHeader.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ _CompanySelector.tsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ nav/
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ _NavUser.tsx
â”‚   â”‚   â”‚   â”‚
â”‚   â”‚   â”‚   â””â”€â”€ common/            # Componentes comunes
â”‚   â”‚   â”‚       â”œâ”€â”€ _PhotoUpload.tsx
â”‚   â”‚   â”‚       â”œâ”€â”€ DataTable.tsx
â”‚   â”‚   â”‚       â””â”€â”€ LoadingSkeleton.tsx
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ hooks/                 # Hooks compartidos
â”‚   â”‚   â”‚   â”œâ”€â”€ index.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ useGeography.ts
â”‚   â”‚   â”‚   â””â”€â”€ use-mobile.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ actions/               # Server Actions compartidas
â”‚   â”‚   â”‚   â”œâ”€â”€ geography.ts
â”‚   â”‚   â”‚   â””â”€â”€ storage.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ lib/                   # Core utilities
â”‚   â”‚   â”‚   â”œâ”€â”€ prisma.ts          # Cliente Prisma
â”‚   â”‚   â”‚   â”œâ”€â”€ logger.ts          # Logger personalizado
â”‚   â”‚   â”‚   â”œâ”€â”€ utils.ts           # cn() y utilidades
â”‚   â”‚   â”‚   â”œâ”€â”€ company.ts         # getActiveCompany()
â”‚   â”‚   â”‚   â””â”€â”€ storage.ts         # S3 presigned URLs
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ types/                 # Tipos globales
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ zodSchemas/            # Schemas Zod compartidos
â”‚   â”‚       â””â”€â”€ index.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ providers/                 # React Context Providers
â”‚   â”‚   â”œâ”€â”€ index.tsx              # Provider combinado
â”‚   â”‚   â”œâ”€â”€ QueryProvider.tsx      # React Query
â”‚   â”‚   â””â”€â”€ SessionProvider.tsx    # Clerk
â”‚   â”‚
â”‚   â””â”€â”€ generated/                 # Auto-generado
â”‚       â””â”€â”€ prisma/                # Cliente Prisma generado
â”‚
â”œâ”€â”€ cypress/                       # Tests E2E
â”‚   â”œâ”€â”€ e2e/
â”‚   â”œâ”€â”€ fixtures/
â”‚   â””â”€â”€ support/
â”‚
â”œâ”€â”€ middleware.ts                  # Middleware de autenticaciÃ³n
â”œâ”€â”€ .env                           # Variables de entorno
â”œâ”€â”€ docker-compose.yml             # Base de datos local
â””â”€â”€ CLAUDE.md                      # Este archivo
```

---

## 4. MÃ“DULOS Y FEATURES

### Los 8 MÃ³dulos del Sistema

| MÃ³dulo | DescripciÃ³n | Ruta Base |
|--------|-------------|-----------|
| `dashboard` | Vista principal, mÃ©tricas | `/dashboard` |
| `employees` | GestiÃ³n de empleados | `/employees` |
| `teams` | Equipos de trabajo | `/teams` |
| `documents` | DocumentaciÃ³n | `/documents` |
| `commercial` | Ãrea comercial | `/commercial` |
| `operations` | Operaciones | `/operations` |
| `maintenance` | Mantenimiento | `/maintenance` |
| `company` | ConfiguraciÃ³n de empresa | `/company` |

### Estructura de un MÃ³dulo

```
modules/{module-name}/
â”œâ”€â”€ features/                  # ğŸ”¥ Sub-funcionalidades (cada pÃ¡gina = feature)
â”‚   â”œâ”€â”€ list/                  # Listado
â”‚   â”‚   â”œâ”€â”€ {Module}List.tsx   # Server Component principal
â”‚   â”‚   â”œâ”€â”€ actions.server.ts  # ğŸ”¥ Actions SOLO de esta feature
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â””â”€â”€ _{Module}Table.tsx  # Client Component
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”œâ”€â”€ detail/                # Detalle/Ver
â”‚   â”‚   â”œâ”€â”€ {Module}Detail.tsx
â”‚   â”‚   â”œâ”€â”€ actions.server.ts  # ğŸ”¥ Actions SOLO de esta feature
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”œâ”€â”€ create/                # Crear nuevo
â”‚   â”‚   â”œâ”€â”€ {Module}Create.tsx
â”‚   â”‚   â”œâ”€â”€ actions.server.ts  # ğŸ”¥ Actions SOLO de esta feature
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”œâ”€â”€ edit/                  # Editar existente
â”‚   â”‚   â”œâ”€â”€ {Module}Edit.tsx
â”‚   â”‚   â”œâ”€â”€ actions.server.ts  # ğŸ”¥ Actions SOLO de esta feature
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â””â”€â”€ {custom}/              # Features especÃ­ficas del mÃ³dulo
â”‚
â”œâ”€â”€ types.ts                   # Tipos compartidos del mÃ³dulo (si los hay)
â”œâ”€â”€ hooks/                     # Hooks especÃ­ficos (opcional)
â”‚   â””â”€â”€ use{Module}.ts
â””â”€â”€ index.ts                   # Barrel export de todas las features
```

**IMPORTANTE**: Cada feature tiene su propio `actions.server.ts` con SOLO las acciones que necesita. NO crear un archivo monolÃ­tico de acciones a nivel de mÃ³dulo.

### Ejemplo: MÃ³dulo Employees

```
modules/employees/
â”œâ”€â”€ features/
â”‚   â”œâ”€â”€ list/
â”‚   â”‚   â”œâ”€â”€ EmployeesList.tsx          # Server Component
â”‚   â”‚   â”œâ”€â”€ actions.server.ts          # getAllEmployees, deleteEmployee
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â””â”€â”€ _EmployeesTable.tsx
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”œâ”€â”€ detail/
â”‚   â”‚   â”œâ”€â”€ EmployeeDetail.tsx         # Server Component
â”‚   â”‚   â”œâ”€â”€ actions.server.ts          # getEmployeeById
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”œâ”€â”€ _EmployeeHeader.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ _PersonalInfoTab.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ _ContactTab.tsx
â”‚   â”‚   â”‚   â””â”€â”€ _WorkInfoTab.tsx
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”œâ”€â”€ create/
â”‚   â”‚   â”œâ”€â”€ EmployeeCreate.tsx         # Server Component
â”‚   â”‚   â”œâ”€â”€ actions.server.ts          # createEmployee, getNextEmployeeNumber
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â””â”€â”€ _EmployeeForm.tsx
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”œâ”€â”€ edit/
â”‚   â”‚   â”œâ”€â”€ EmployeeEdit.tsx           # Server Component
â”‚   â”‚   â”œâ”€â”€ actions.server.ts          # updateEmployee, getEmployeeForEdit
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â””â”€â”€ charts/                        # Feature adicional (opcional)
â”‚       â”œâ”€â”€ EmployeeCharts.tsx
â”‚       â”œâ”€â”€ actions.server.ts
â”‚       â””â”€â”€ index.ts
â”‚
â”œâ”€â”€ types.ts                   # Tipos compartidos (si los hay)
â””â”€â”€ index.ts                   # Barrel export con aliases backward-compatible
```

### Ejemplo: MÃ³dulo Company (con sub-features)

```
modules/company/
â”œâ”€â”€ features/
â”‚   â”œâ”€â”€ overview/              # /company
â”‚   â”‚   â”œâ”€â”€ CompanyOverview.tsx
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”œâ”€â”€ unions/                # /company/unions
â”‚   â”‚   â”œâ”€â”€ UnionsList.tsx
â”‚   â”‚   â”œâ”€â”€ UnionDetail.tsx
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â””â”€â”€ _UnionsTable.tsx
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”œâ”€â”€ job-positions/         # /company/job-positions
â”‚   â”‚   â”œâ”€â”€ JobPositionsList.tsx
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â””â”€â”€ _JobPositionsTable.tsx
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”œâ”€â”€ job-categories/        # /company/job-categories
â”‚   â”œâ”€â”€ cost-centers/          # /company/cost-centers
â”‚   â”œâ”€â”€ contract-types/        # /company/contract-types
â”‚   â””â”€â”€ collective-agreements/ # /company/collective-agreements
â”‚
â”œâ”€â”€ actions.server.ts          # Acciones de TODOS los sub-features
â”œâ”€â”€ types.ts
â””â”€â”€ index.ts
```

### Barrel Export del MÃ³dulo

```typescript
// modules/employees/index.ts
export { EmployeesList } from './features/list';
export { EmployeeDetail } from './features/detail';
export { EmployeeCreate } from './features/create';
export { EmployeeEdit } from './features/edit';
export { EmployeeCharts } from './features/charts';

// Server Actions
export * from './actions.server';

// Types
export type * from './types';
```

---

## 5. ROUTE GROUPS EN APP ROUTER

### Grupos de Rutas

Todas las rutas de la aplicaciÃ³n principal estÃ¡n bajo el prefijo `/dashboard`:

```
app/
â”œâ”€â”€ (auth)/                    # Rutas de autenticaciÃ³n (pÃºblicas)
â”‚   â”œâ”€â”€ sign-in/
â”‚   â””â”€â”€ sign-up/
â”‚
â”œâ”€â”€ (core)/                    # Rutas principales (protegidas)
â”‚   â””â”€â”€ dashboard/             # ğŸ”¥ Prefijo /dashboard para toda la app
â”‚       â”œâ”€â”€ layout.tsx         # DashboardLayout con Sidebar/Header
â”‚       â”œâ”€â”€ page.tsx           # /dashboard (home)
â”‚       â”œâ”€â”€ employees/         # /dashboard/employees
â”‚       â”œâ”€â”€ companies/         # /dashboard/companies
â”‚       â”œâ”€â”€ equipment/         # /dashboard/equipment
â”‚       â””â”€â”€ company/           # /dashboard/company (configuraciÃ³n)
â”‚           â”œâ”€â”€ unions/        # /dashboard/company/unions
â”‚           â”œâ”€â”€ job-positions/ # /dashboard/company/job-positions
â”‚           â””â”€â”€ ...
â”‚
â””â”€â”€ api/                       # API Routes
```

### URLs Resultantes

| Ruta en app/ | URL Final |
|--------------|-----------|
| `(core)/dashboard/page.tsx` | `/dashboard` |
| `(core)/dashboard/employees/page.tsx` | `/dashboard/employees` |
| `(core)/dashboard/employees/new/page.tsx` | `/dashboard/employees/new` |
| `(core)/dashboard/employees/[id]/page.tsx` | `/dashboard/employees/123` |
| `(core)/dashboard/company/unions/page.tsx` | `/dashboard/company/unions` |

### PÃ¡gina DELGADA - PatrÃ³n Correcto

```typescript
// src/app/(core)/dashboard/employees/page.tsx
import { EmployeesPage } from '@/modules/employees';

export const metadata: Metadata = { title: 'Empleados' };

export default function Page() {
  return <EmployeesPage />;
}
```

```typescript
// src/app/(core)/dashboard/employees/[id]/page.tsx
import { EmployeeDetailPage } from '@/modules/employees';

export default async function Page({
  params,
}: {
  params: Promise<{ id: string }>;
}) {
  const { id } = await params;
  return <EmployeeDetailPage id={id} />;
}
```

```typescript
// src/app/(core)/dashboard/company/unions/page.tsx
import { UnionsPage } from '@/modules/company';

export const metadata: Metadata = { title: 'Sindicatos' };

export default function Page() {
  return <UnionsPage />;
}
```

### Layout del Core

```typescript
// src/app/(core)/layout.tsx
import { AppSidebar, SiteHeader } from '@/shared/components/layout';
import { SidebarProvider, SidebarInset } from '@/shared/components/ui/sidebar';

export default function CoreLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <SidebarProvider>
      <AppSidebar />
      <SidebarInset>
        <SiteHeader />
        <main className="flex-1 p-6">{children}</main>
      </SidebarInset>
    </SidebarProvider>
  );
}
```

---

## 6. REGLAS CRÃTICAS

### REGLA 0: Tipado SIEMPRE desde Prisma o Zod - NUNCA manual

```typescript
// âŒ NUNCA - Mapeos manuales de enums que existen en Prisma
const genderLabels: Record<string, string> = {
  MALE: 'Masculino',
  FEMALE: 'Femenino',
  NOT_DECLARED: 'No declarado',
};

// âœ… SIEMPRE - Usar el enum de Prisma y crear mapeo tipado
import { Gender } from '@/generated/prisma/enums';

const genderLabels: Record<Gender, string> = {
  MALE: 'Masculino',
  FEMALE: 'Femenino',
  NOT_DECLARED: 'No declarado',
};

// âŒ NUNCA - Valores que NO existen en el enum de Prisma
const statusLabels = {
  ACTIVE: 'Activo',        // Â¡Este valor NO existe en EmployeeStatus!
  PENDING_REVIEW: 'Pendiente', // Â¡Este tampoco!
};

// âœ… SIEMPRE - Verificar que los valores coincidan con Prisma
import { EmployeeStatus } from '@/generated/prisma/enums';

const statusLabels: Record<EmployeeStatus, string> = {
  INCOMPLETE: 'Incompleto',
  COMPLETE: 'Completo',
  COMPLETE_EXPIRED_DOCS: 'Docs Vencidos',
  APPROVED: 'Aprobado',
  NOT_APPROVED: 'No Aprobado',
};
```

### Regla de Tipado - Orden de Preferencia

1. **Prisma Enums**: Si el valor viene de la BD, usar `@/generated/prisma/enums`
2. **Prisma Types**: Para modelos, usar tipos inferidos de las queries
3. **Zod Schemas**: Para formularios, inferir de `z.infer<typeof schema>`
4. **Manual SOLO si**: Es un tipo compuesto que no existe en ningÃºn lado

```typescript
// 1. Enums de Prisma
import { Gender, EmployeeStatus, CostType } from '@/generated/prisma/enums';

// 2. Tipos inferidos de queries
export type Employee = Awaited<ReturnType<typeof getEmployeeById>>;

// 3. Tipos de Zod
const employeeSchema = z.object({ ... });
type EmployeeFormData = z.infer<typeof employeeSchema>;

// 4. Solo si no existe en ningÃºn lado
interface EmployeeWithCalculatedFields {
  employee: Employee;
  age: number;
  seniority: string;
}
```

### REGLA 1: NO usar `:any` - SIEMPRE inferir tipos

```typescript
// âŒ NUNCA
const data: any = await fetchData();
function process(item: any) { ... }

// âœ… SIEMPRE inferir tipos
export type Employee = Awaited<ReturnType<typeof getEmployeeById>>;
export type EmployeeList = Awaited<ReturnType<typeof getAllEmployees>>;

// âœ… Para arrays
type Employee = EmployeeList[number];
```

### REGLA 2: Server Actions en el mÃ³dulo, NO en carpeta separada

```typescript
// âŒ NUNCA crear carpeta src/app/server/
// âŒ NUNCA src/actions/ a nivel global

// âœ… SIEMPRE en el mÃ³dulo correspondiente
// src/modules/employees/actions.server.ts
'use server';

import { prisma } from '@/shared/lib/prisma';

export async function getAllEmployees() {
  return await prisma.employee.findMany();
}

// âœ… O en shared si se usa en mÃºltiples mÃ³dulos
// src/shared/actions/geography.ts
'use server';

export async function getAllCountries() { ... }
```

### REGLA 3: Logger, NUNCA console.*

```typescript
// âŒ NUNCA
console.log('mensaje');
console.error('error');

// âœ… SIEMPRE
import { logger, Logger } from '@/shared/lib/logger';

// Logger global
logger.info('mensaje');
logger.error('error', { data: { error } });

// Logger con scope
const log = new Logger('MiComponente');
log.info('mensaje');
```

### REGLA 4: moment.js para fechas, NUNCA date-fns

```typescript
// âŒ NUNCA
import { format } from 'date-fns';

// âœ… SIEMPRE
import moment from 'moment';
moment(date).format('DD/MM/YYYY');
```

### REGLA 5: Componentes Cliente inician con `_`

```typescript
// Server Component (por defecto)
modules/employees/features/list/EmployeesList.tsx

// Client Component (interactividad)
modules/employees/features/list/components/_EmployeesTable.tsx  // â† Nota el _
```

### REGLA 6: Queries eficientes - NO N+1

```typescript
// âŒ NUNCA - N+1 Query
const employees = await prisma.employee.findMany();
for (const emp of employees) {
  const department = await prisma.department.findUnique({...});
}

// âœ… SIEMPRE - Una sola query con relaciones
const employees = await prisma.employee.findMany({
  include: { department: true }
});
```

### REGLA 7: MÃ³dulos NO importan de otros mÃ³dulos

```typescript
// âŒ INCORRECTO - MÃ³dulo importa de otro mÃ³dulo
// En modules/employees/...
import { someUtil } from '@/modules/company/utils';

// âœ… CORRECTO - Usar shared para cÃ³digo compartido
import { someUtil } from '@/shared/utils/someUtil';
```

### REGLA 8: Utils y Mappers en shared/ - NUNCA inline en componentes

```typescript
// âŒ NUNCA - Helpers y mapeos inline en componentes
// modules/employees/features/detail/EmployeeDetail.tsx
function formatDate(date: Date) { ... }  // Â¡NO inline!
const genderLabels = { ... };             // Â¡NO inline!

export function EmployeeDetail() {
  // ...
}

// âœ… SIEMPRE - Utils en shared/utils/
// shared/utils/formatters.ts
import moment from 'moment';

export function formatDate(date: Date | string | null): string {
  if (!date) return 'No especificada';
  return moment(date).format('DD/MM/YYYY');
}

export function calculateAge(birthDate: Date | string | null): number | null {
  if (!birthDate) return null;
  return moment().diff(moment(birthDate), 'years');
}

// âœ… SIEMPRE - Mappers en shared/utils/mappers.ts
// shared/utils/mappers.ts
import {
  Gender,
  EmployeeStatus,
  MaritalStatus,
  EducationLevel,
  CostType,
  UnionAffiliationStatus,
} from '@/generated/prisma/enums';

export const genderLabels: Record<Gender, string> = {
  MALE: 'Masculino',
  FEMALE: 'Femenino',
  NOT_DECLARED: 'No declarado',
};

export const employeeStatusLabels: Record<EmployeeStatus, string> = {
  INCOMPLETE: 'Incompleto',
  COMPLETE: 'Completo',
  COMPLETE_EXPIRED_DOCS: 'Documentos Vencidos',
  APPROVED: 'Aprobado',
  NOT_APPROVED: 'No Aprobado',
};

// Con variantes de Badge
export const employeeStatusBadges: Record<EmployeeStatus, {
  label: string;
  variant: 'default' | 'secondary' | 'destructive' | 'outline'
}> = {
  INCOMPLETE: { label: 'Incompleto', variant: 'secondary' },
  COMPLETE: { label: 'Completo', variant: 'outline' },
  COMPLETE_EXPIRED_DOCS: { label: 'Docs Vencidos', variant: 'destructive' },
  APPROVED: { label: 'Aprobado', variant: 'default' },
  NOT_APPROVED: { label: 'No Aprobado', variant: 'destructive' },
};
```

### REGLA 9: Componentes pequeÃ±os y reutilizables - NO mega-componentes

```typescript
// âŒ NUNCA - Un componente de 300+ lÃ­neas con todo inline
// EmployeeDetailPage.tsx con helpers, mapeos, InfoField, tabs, etc.

// âœ… SIEMPRE - Componentes pequeÃ±os y reutilizables
// shared/components/common/InfoField.tsx
interface InfoFieldProps {
  label: string;
  value: string | null | undefined;
  fallback?: string;
}

export function InfoField({ label, value, fallback = 'No especificado' }: InfoFieldProps) {
  return (
    <div className="space-y-1">
      <p className="text-sm text-muted-foreground">{label}</p>
      <p className="font-medium">{value || fallback}</p>
    </div>
  );
}

// Uso en features
import { InfoField } from '@/shared/components/common/InfoField';
import { formatDate, calculateAge } from '@/shared/utils/formatters';
import { genderLabels } from '@/shared/utils/mappers';

<InfoField label="GÃ©nero" value={genderLabels[employee.gender]} />
<InfoField label="Fecha de Nacimiento" value={formatDate(employee.birthDate)} />
```

### REGLA 10: Features con su propia estructura - NO archivos sueltos

```typescript
// âŒ INCORRECTO - Archivos sueltos en el root del mÃ³dulo
modules/employees/
â”œâ”€â”€ EmployeesPage.tsx           // âŒ Suelto
â”œâ”€â”€ EmployeeDetailPage.tsx      // âŒ Suelto
â”œâ”€â”€ EmployeeEditPage.tsx        // âŒ Suelto
â”œâ”€â”€ EmployeeNewPage.tsx         // âŒ Suelto
â”œâ”€â”€ actionsServer.ts            // âŒ TODAS las actions juntas (500+ lÃ­neas)
â””â”€â”€ components/
    â””â”€â”€ _EmployeeForm.tsx       // âŒ Un form gigante para todo

// âœ… CORRECTO - Cada pÃ¡gina es una feature con su estructura
modules/employees/
â”œâ”€â”€ features/
â”‚   â”œâ”€â”€ list/                   # Feature: Lista de empleados
â”‚   â”‚   â”œâ”€â”€ EmployeesList.tsx   # Server Component
â”‚   â”‚   â”œâ”€â”€ actions.server.ts   # Solo: getAllEmployees, getEmployeesForSelect
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â””â”€â”€ _EmployeesTable.tsx
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ detail/                 # Feature: Detalle de empleado
â”‚   â”‚   â”œâ”€â”€ EmployeeDetail.tsx
â”‚   â”‚   â”œâ”€â”€ actions.server.ts   # Solo: getEmployeeById
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”œâ”€â”€ _PersonalInfoTab.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ _ContactTab.tsx
â”‚   â”‚   â”‚   â””â”€â”€ _WorkInfoTab.tsx
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ create/                 # Feature: Crear empleado
â”‚   â”‚   â”œâ”€â”€ EmployeeCreate.tsx
â”‚   â”‚   â”œâ”€â”€ actions.server.ts   # Solo: createEmployee, getNextEmployeeNumber
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â””â”€â”€ _EmployeeForm.tsx
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚
â”‚   â””â”€â”€ edit/                   # Feature: Editar empleado
â”‚       â”œâ”€â”€ EmployeeEdit.tsx
â”‚       â”œâ”€â”€ actions.server.ts   # Solo: updateEmployee, terminateEmployee
â”‚       â””â”€â”€ index.ts
â”‚
â”œâ”€â”€ types.ts                    # Tipos compartidos del mÃ³dulo (si los hay)
â””â”€â”€ index.ts                    # Barrel export de todas las features
```

### REGLA 11: Queries optimizadas - usar `select` para traer solo lo necesario

```typescript
// âŒ NUNCA - Traer todos los campos cuando solo necesitas algunos
const employees = await prisma.employee.findMany({
  include: {
    jobPosition: true,      // Trae TODOS los campos
    contractType: true,     // Trae TODOS los campos
    nationality: true,      // Trae TODOS los campos
  }
});

// âœ… SIEMPRE - Usar select para traer solo lo que se usa
const employees = await prisma.employee.findMany({
  include: {
    jobPosition: { select: { id: true, name: true } },
    contractType: { select: { id: true, name: true } },
    nationality: { select: { id: true, name: true } },
  }
});

// âœ… Para selects/dropdowns - SIEMPRE usar select mÃ­nimo
const selectForDropdown = { id: true, name: true } as const;

const options = await prisma.jobPosition.findMany({
  where: { companyId, isActive: true },
  select: selectForDropdown,
  orderBy: { name: 'asc' },
});

// âœ… Para mutations - retornar solo el id despuÃ©s de crear/actualizar
const employee = await prisma.employee.create({
  data: { ... },
  select: { id: true },  // No necesitas el objeto completo
});

// âœ… Para verificaciones de existencia - solo traer id
const existing = await prisma.employee.findFirst({
  where: { id, companyId },
  select: { id: true },  // Solo verificas si existe
});
```

### REGLA 12: `getActiveCompanyId()` en Server Actions, `getActiveCompany()` solo en UI

```typescript
// âŒ NUNCA en server actions - trae datos innecesarios
// modules/employees/features/list/actions.server.ts
import { getActiveCompany } from '@/shared/lib/company';

export async function getAllEmployees() {
  const company = await getActiveCompany();  // Trae province, city, _count...
  if (!company) throw new Error('No hay empresa activa');
  
  return prisma.employee.findMany({
    where: { companyId: company.id },  // Solo usas el id
  });
}

// âœ… SIEMPRE en server actions - versiÃ³n ligera
import { getActiveCompanyId } from '@/shared/lib/company';

export async function getAllEmployees() {
  const companyId = await getActiveCompanyId();  // Solo trae el id
  if (!companyId) throw new Error('No hay empresa activa');
  
  return prisma.employee.findMany({
    where: { companyId },
  });
}

// âœ… getActiveCompany() SOLO en componentes de UI que muestran datos de la empresa
// app/(core)/layout.tsx
import { getActiveCompany } from '@/shared/lib/company';

export default async function Layout({ children }) {
  const activeCompany = await getActiveCompany();  // Necesita nombre, provincia, etc.
  return <DashboardLayout activeCompany={activeCompany}>{children}</DashboardLayout>;
}
```

### REGLA 13: NUNCA tipar explÃ­citamente el return de funciones - SIEMPRE inferir

```typescript
// âŒ NUNCA - Tipar manualmente el return
export async function getEmployeeById(id: string): Promise<Employee | null> {
  // ...
}

interface Employee {
  id: string;
  name: string;
  // 50 campos mÃ¡s que hay que mantener manualmente...
}

// âœ… SIEMPRE - Dejar que TypeScript infiera el tipo
export async function getEmployeeById(id: string) {
  const companyId = await getActiveCompanyId();
  if (!companyId) throw new Error('No hay empresa activa');

  return prisma.employee.findFirst({
    where: { id, companyId },
    include: { jobPosition: { select: { id: true, name: true } } },
  });
}

// âœ… Exportar tipo inferido al final del archivo
export type Employee = Awaited<ReturnType<typeof getEmployeeById>>;
export type EmployeeList = Awaited<ReturnType<typeof getAllEmployees>>;

// âœ… Para arrays, extraer el tipo del elemento
type EmployeeListItem = EmployeeList[number];
```

---

## 7. SERVER COMPONENTS FIRST

### Regla Fundamental

**Server Components por defecto. Client Components SOLO cuando sea necesario.**

### CuÃ¡ndo usar Client Component ('use client')

1. **Interactividad**: onClick, onChange, onSubmit
2. **Estado local**: useState, useReducer
3. **React Query**: useQuery, useMutation
4. **Hooks del navegador**: useEffect con window/document
5. **Context API**: useContext

### PatrÃ³n HÃ­brido en Features

```typescript
// 1. Server Component (fetching inicial)
// modules/employees/features/list/EmployeesList.tsx
import { getAllEmployees } from '../../actions.server';
import { _EmployeesTable } from './components/_EmployeesTable';

export async function EmployeesList() {
  const employees = await getAllEmployees();
  return <_EmployeesTable initialData={employees} />;
}

// 2. Client Component (interactividad)
// modules/employees/features/list/components/_EmployeesTable.tsx
'use client';

import { useQuery } from '@tanstack/react-query';
import { getAllEmployees } from '../../../actions.server';

interface Props {
  initialData: Employee[];
}

export function _EmployeesTable({ initialData }: Props) {
  const { data } = useQuery({
    queryKey: ['employees'],
    queryFn: getAllEmployees,
    initialData,
  });

  return <DataTable data={data} />;
}
```

---

## 8. SERVER ACTIONS

### UbicaciÃ³n: actions.server.ts en cada FEATURE (no en mÃ³dulo)

Cada feature tiene su propio archivo de actions con SOLO las funciones que necesita:

```typescript
// modules/employees/features/list/actions.server.ts
'use server';

import { prisma } from '@/shared/lib/prisma';
import { logger } from '@/shared/lib/logger';
import { getActiveCompany } from '@/shared/lib/company';

export async function getAllEmployees() {
  const company = await getActiveCompany();
  if (!company) throw new Error('No hay empresa activa');

  try {
    return await prisma.employee.findMany({
      where: { companyId: company.id },
      include: { jobPosition: true, contractType: true },
      orderBy: { createdAt: 'desc' },
    });
  } catch (error) {
    logger.error('Error getting employees', { data: { error } });
    throw new Error('Error al obtener empleados');
  }
}

export async function deleteEmployee(id: string) {
  // Solo delete en feature list
}

// Tipo inferido
export type EmployeeListItem = Awaited<ReturnType<typeof getAllEmployees>>[number];
```

```typescript
// modules/employees/features/detail/actions.server.ts
'use server';

export async function getEmployeeById(id: string) {
  // Solo getById en feature detail
}

export type Employee = Awaited<ReturnType<typeof getEmployeeById>>;
```

```typescript
// modules/employees/features/create/actions.server.ts
'use server';

export async function createEmployee(data: CreateEmployeeInput) {
  // Solo create en feature create
}

export async function getNextEmployeeNumber() {
  // Helper especÃ­fico de create
}
```

```typescript
// modules/employees/features/edit/actions.server.ts
'use server';

export async function updateEmployee(id: string, data: UpdateEmployeeInput) {
  // Solo update en feature edit
}

export async function getEmployeeForEdit(id: string) {
  // Query especÃ­fica para ediciÃ³n
}
```

### Nomenclatura de Server Actions

| Tipo | Pattern | Ejemplo |
|------|---------|---------|
| GET todos | `getAll{Entity}` | `getAllEmployees` |
| GET filtrado | `get{Filter}{Entity}` | `getActiveEmployees` |
| GET por ID | `get{Entity}ById` | `getEmployeeById` |
| GET por relaciÃ³n | `get{Entity}By{Relation}` | `getEmployeesByDepartment` |
| POST | `create{Entity}` | `createEmployee` |
| PUT/PATCH | `update{Entity}` | `updateEmployee` |
| DELETE soft | `softDelete{Entity}` | `softDeleteEmployee` |
| DELETE hard | `hardDelete{Entity}` | `hardDeleteEmployee` |

---

## 9. COMUNICACIÃ“N ENTRE MÃ“DULOS

### Regla: Los mÃ³dulos NO se comunican directamente

```typescript
// âŒ INCORRECTO - MÃ³dulo A importa de MÃ³dulo B
// En modules/employees/features/create/_EmployeeForm.tsx
import { getAllDepartments } from '@/modules/company/actions.server';

// âœ… CORRECTO - Usar shared/actions para datos compartidos
// En shared/actions/catalogs.ts
'use server';

export async function getAllDepartmentsForSelect(companyId: string) {
  return await prisma.department.findMany({
    where: { companyId },
    select: { id: true, name: true },
  });
}

// En modules/employees/features/create/_EmployeeForm.tsx
import { getAllDepartmentsForSelect } from '@/shared/actions/catalogs';
```

### CuÃ¡ndo mover a shared/actions

Mover a `shared/actions/` cuando:
- La acciÃ³n se usa en **2+ mÃ³dulos**
- Es un catÃ¡logo/select usado en formularios de varios mÃ³dulos
- Es una operaciÃ³n genÃ©rica (geografÃ­a, storage, etc.)

### PatrÃ³n de ComunicaciÃ³n

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Module A      â”‚     â”‚   Module B      â”‚
â”‚   employees     â”‚     â”‚   company       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚
         â”‚    NO DIRECTO âœ—       â”‚
         â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
         â”‚                       â”‚
         â–¼                       â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚        shared/actions/          â”‚
    â”‚   - catalogs.ts                 â”‚
    â”‚   - geography.ts                â”‚
    â”‚   - storage.ts                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 10. FETCHING CON REACT QUERY

### REGLA CRÃTICA

```typescript
// âŒ NUNCA - useEffect + useState
const [data, setData] = useState([]);
useEffect(() => {
  fetchData().then(setData);
}, []);

// âœ… SIEMPRE - useQuery
const { data, isLoading } = useQuery({
  queryKey: ['employees'],
  queryFn: getAllEmployees,
});
```

### Hook Pattern por MÃ³dulo

```typescript
// modules/employees/hooks/useEmployees.ts
'use client';

import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import {
  getAllEmployees,
  createEmployee,
  updateEmployee,
} from '../actions.server';

export function useEmployees(companyId: string) {
  return useQuery({
    queryKey: ['employees', companyId],
    queryFn: () => getAllEmployees(companyId),
    staleTime: 5 * 60 * 1000,
  });
}

export function useCreateEmployee() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: createEmployee,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['employees'] });
    },
  });
}
```

---

## 11. SISTEMA DE PERMISOS

### Arquitectura RBAC

```
modules â†’ features â†’ actions (view, create, update, delete)
```

### VerificaciÃ³n en Server Actions

```typescript
// modules/employees/actions.server.ts
'use server';

import { checkPermission } from '@/shared/lib/permissions';

export async function createEmployee(data: EmployeeInsert) {
  await checkPermission('employees', 'create');
  return await prisma.employee.create({ data });
}
```

### VerificaciÃ³n en UI

```typescript
import { PermissionGuard } from '@/shared/components/PermissionGuard';

<PermissionGuard module="employees" action="create">
  <Button>Crear Empleado</Button>
</PermissionGuard>
```

---

## 12. COMPONENTES UI Y SHADCN

### UbicaciÃ³n

```
shared/components/ui/          # Componentes shadcn
shared/components/layout/      # Sidebar, Header, etc.
shared/components/common/      # DataTable, PhotoUpload, etc.
```

### InstalaciÃ³n

```bash
npx shadcn@latest add [componente]
```

### Uso Correcto

```typescript
import { Button } from '@/shared/components/ui/button';
import { Card } from '@/shared/components/ui/card';
import { AppSidebar } from '@/shared/components/layout';
import { DataTable } from '@/shared/components/common/DataTable';
```

### Clase Utility `cn`

```typescript
import { cn } from '@/shared/lib/utils';

<div className={cn('base', condition && 'conditional')} />
```

### DataTable - Columnas con `meta.title`

Al definir columnas para DataTable, **siempre incluir `meta: { title: 'X' }`** para que el dropdown "Mostrar columnas" muestre nombres legibles:

```typescript
// âŒ INCORRECTO - El dropdown mostrarÃ¡ "employeeNumber"
{
  accessorKey: 'employeeNumber',
  header: ({ column }) => (
    <DataTableColumnHeader column={column} title="Legajo" />
  ),
}

// âœ… CORRECTO - El dropdown mostrarÃ¡ "Legajo"
{
  accessorKey: 'employeeNumber',
  meta: { title: 'Legajo' },
  header: ({ column }) => (
    <DataTableColumnHeader column={column} title="Legajo" />
  ),
}
```

Ver documentaciÃ³n completa en: `src/shared/components/common/DataTable/DOCS.md`

### DiseÃ±o Responsive - OBLIGATORIO

**Toda implementaciÃ³n DEBE ser responsive.** Al crear o modificar componentes, usar el mejor criterio para decidir cÃ³mo mostrar el contenido en diferentes tamaÃ±os de pantalla.

#### Breakpoints de Tailwind

| Breakpoint | MÃ­nimo | Uso tÃ­pico |
|------------|--------|------------|
| `sm` | 640px | MÃ³viles grandes |
| `md` | 768px | Tablets |
| `lg` | 1024px | Laptops |
| `xl` | 1280px | Desktop |
| `2xl` | 1536px | Monitores grandes |

#### Patrones Responsive Comunes

```typescript
// 1. Ocultar/mostrar elementos segÃºn breakpoint
<div className="hidden md:block">Solo visible en desktop</div>
<div className="md:hidden">Solo visible en mobile</div>

// 2. Layouts diferentes por breakpoint
<div className="flex flex-col md:flex-row">...</div>
<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3">...</div>

// 3. Envolver componentes que no respetan hidden/flex
// âŒ INCORRECTO - El componente interno puede sobreescribir el display
<ResizablePanelGroup className="hidden md:flex">

// âœ… CORRECTO - Envolver en div contenedor
<div className="hidden md:flex flex-1">
  <ResizablePanelGroup>...</ResizablePanelGroup>
</div>
```

#### Estrategias por Tipo de Contenido

| Contenido | Desktop | Mobile |
|-----------|---------|--------|
| **Tablas de datos** | DataTable completa | Ocultar columnas secundarias o usar cards |
| **Paneles lado a lado** | ResizablePanelGroup | Mostrar uno, botÃ³n para ver el otro |
| **PDFs/Documentos** | Iframe embebido | BotÃ³n "Abrir" (visor nativo del dispositivo) |
| **Formularios largos** | Multi-columna | Single column |
| **Modales/Dialogs** | Dialog centrado | Sheet desde bottom (mÃ¡s natural en touch) |
| **NavegaciÃ³n** | Sidebar visible | Sidebar colapsable/Sheet |

#### Uso del MCP de shadcn

**SIEMPRE usar el MCP de shadcn** para buscar componentes y ejemplos antes de implementar:

```
1. Buscar componentes: mcp__shadcn__search_items_in_registries
2. Ver ejemplos de uso: mcp__shadcn__get_item_examples_from_registries
3. Ver detalles del componente: mcp__shadcn__view_items_in_registries
```

Componentes shadcn Ãºtiles para responsive:
- `Sheet` - Para paneles laterales/inferiores en mobile
- `Drawer` - Alternativa a Dialog en mobile
- `Collapsible` - Colapsar contenido secundario
- `ScrollArea` - Scroll controlado en contenedores
- `AspectRatio` - Mantener proporciones en imÃ¡genes/videos

#### Ejemplo: Detalle de Documento

```typescript
// Desktop: Paneles redimensionables lado a lado
// Mobile: Info con botÃ³n para abrir documento en nueva pestaÃ±a

export function DocumentDetail() {
  return (
    <div className="flex h-full flex-col">
      {/* Mobile Layout */}
      <div className="flex-1 md:hidden">
        <ScrollArea className="h-full">
          <MobileDocumentCard />  {/* BotÃ³n "Abrir" que usa visor nativo */}
          <DocumentInfo />
        </ScrollArea>
      </div>

      {/* Desktop Layout */}
      <div className="hidden md:flex flex-1">
        <ResizablePanelGroup orientation="horizontal">
          <ResizablePanel><DocumentPreview /></ResizablePanel>
          <ResizableHandle />
          <ResizablePanel><DocumentInfo /></ResizablePanel>
        </ResizablePanelGroup>
      </div>
    </div>
  );
}
```

---

## 13. FORMULARIOS

### Stack

- **React Hook Form**: GestiÃ³n del formulario
- **Zod**: ValidaciÃ³n de esquemas
- **@hookform/resolvers**: IntegraciÃ³n

### Template

```typescript
// modules/employees/features/create/components/_EmployeeForm.tsx
'use client';

import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import { useMutation } from '@tanstack/react-query';
import { createEmployee } from '../../../actions.server';

const schema = z.object({
  name: z.string().min(2, 'Nombre requerido'),
  email: z.string().email('Email invÃ¡lido'),
});

type FormData = z.infer<typeof schema>;

export function _EmployeeForm() {
  const { register, handleSubmit, formState: { errors } } = useForm<FormData>({
    resolver: zodResolver(schema),
  });

  const mutation = useMutation({
    mutationFn: createEmployee,
  });

  const onSubmit = (data: FormData) => mutation.mutate(data);

  return (
    <form onSubmit={handleSubmit(onSubmit)}>
      {/* ... */}
    </form>
  );
}
```

---

## 14. BASE DE DATOS CON PRISMA

### UbicaciÃ³n

```
prisma/schema.prisma           # Schema
src/shared/lib/prisma.ts       # Cliente
src/generated/prisma/          # Generado
```

### ConfiguraciÃ³n (Prisma 7)

```typescript
// src/shared/lib/prisma.ts
import { PrismaClient } from '@/generated/prisma/client';
import { PrismaPg } from '@prisma/adapter-pg';

const adapter = new PrismaPg({ connectionString: process.env.DATABASE_URL });
export const prisma = new PrismaClient({ adapter });
```

### Comandos

```bash
npm run db:generate    # Generar cliente
npm run db:push        # Push schema (dev)
npm run db:migrate     # Crear migraciÃ³n
npm run db:studio      # Abrir Studio
```

---

## 15. NOMENCLATURAS Y CONVENCIONES

### Archivos

| Tipo | Nomenclatura | Ejemplo |
|------|--------------|---------|
| Server Component | PascalCase.tsx | `EmployeesList.tsx` |
| Client Component | _PascalCase.tsx | `_EmployeesTable.tsx` |
| Server Actions | actions.server.ts | `actions.server.ts` |
| Types | types.ts | `types.ts` |
| Hooks | use{Name}.ts | `useEmployees.ts` |
| Barrel export | index.ts | `index.ts` |

### Carpetas

| Tipo | Nomenclatura |
|------|--------------|
| MÃ³dulos | kebab-case | `employees`, `job-positions` |
| Features | kebab-case | `list`, `detail`, `create` |
| Componentes dentro de feature | PascalCase |

### Imports con Path Alias

```typescript
// âœ… CORRECTO
import { Button } from '@/shared/components/ui/button';
import { prisma } from '@/shared/lib/prisma';
import { EmployeesList } from '@/modules/employees';

// âŒ INCORRECTO - Imports relativos profundos
import { Button } from '../../../shared/components/ui/button';
```

---

## 16. LOGGER Y DEBUGGING

### Uso

```typescript
import { logger, Logger } from '@/shared/lib/logger';

// Global
logger.info('Mensaje');
logger.error('Error', { data: { error } });

// Con scope
const log = new Logger('EmployeeForm');
log.info('Form submitted');
```

### Control

```env
NEXT_PUBLIC_SHOW_LOGS="true"   # Dev
NEXT_PUBLIC_SHOW_LOGS="false"  # Prod
```

---

## 17. COMANDOS DISPONIBLES

```bash
# Desarrollo
npm run dev              # Servidor con Turbopack
npm run build            # Build producciÃ³n
npm run start            # Servidor producciÃ³n

# Calidad
npm run lint             # ESLint
npm run lint:fix         # Corregir ESLint
npm run format           # Prettier
npm run check-types      # TypeScript

# Base de Datos
npm run db:generate      # Generar Prisma
npm run db:push          # Push schema
npm run db:migrate       # Crear migraciÃ³n
npm run db:studio        # Prisma Studio

# Testing
npm run cy:open          # Cypress UI
npm run cy:run           # Cypress headless
```

---

## 18. CHECKLISTS

### Checklist para Nuevo MÃ³dulo

- [ ] Crear carpeta en `src/modules/{module-name}/`
- [ ] Crear `actions.server.ts` con Server Actions
- [ ] Crear `types.ts` con tipos inferidos
- [ ] Crear `index.ts` con barrel exports
- [ ] Crear carpeta `features/` con al menos `list/`
- [ ] Crear rutas en `app/(core)/{module-name}/`

### Checklist para Nueva Feature

- [ ] Crear carpeta en `modules/{module}/features/{feature-name}/`
- [ ] Crear Server Component principal (`{Feature}.tsx`)
- [ ] Crear `components/` con Client Components (prefijo `_`)
- [ ] Crear `index.ts` con exports
- [ ] Agregar ruta en `app/(core)/`

### Checklist para Nuevo Componente Cliente

- [ ] Archivo inicia con `_` (ej: `_MyComponent.tsx`)
- [ ] Primera lÃ­nea: `'use client';`
- [ ] Usar `useQuery` para fetching (NO useEffect)
- [ ] Recibir `initialData` del Server Component padre

### Checklist para Columnas de DataTable

- [ ] Cada columna tiene `meta: { title: 'TÃ­tulo' }` para el dropdown "Mostrar columnas"
- [ ] El tÃ­tulo en `meta.title` coincide con el `title` de `DataTableColumnHeader`
- [ ] Columnas de selecciÃ³n tienen `enableHiding: false`
- [ ] Columnas de acciones NO necesitan `meta.title` (no tienen `accessorFn`)

### Checklist antes de Commit

- [ ] `npm run check-types` pasa
- [ ] `npm run lint` pasa
- [ ] `npm run format` aplicado
- [ ] No hay `console.*` (solo `logger`)
- [ ] No hay `:any` en tipos
- [ ] Server Components por defecto
- [ ] Client Components tienen `_` en nombre
- [ ] MÃ³dulos no importan de otros mÃ³dulos
- [ ] **Enums usan tipos de Prisma** (`@/generated/prisma/enums`)
- [ ] **No hay mapeos inline** (usar `shared/utils/mappers.ts`)
- [ ] **No hay helpers inline** (usar `shared/utils/formatters.ts`)
- [ ] **Componentes < 200 lÃ­neas** (dividir si son mÃ¡s grandes)
- [ ] **Features tienen su carpeta** (no archivos sueltos en mÃ³dulo)
- [ ] **Queries usan `select`** para traer solo campos necesarios
- [ ] **Server actions usan `getActiveCompanyId()`** (no `getActiveCompany()`)
- [ ] **No hay tipos de retorno explÃ­citos** en funciones (inferir con `Awaited<ReturnType<>>`)
- [ ] **Columnas de DataTable tienen `meta.title`** para el dropdown de visibilidad
- [ ] **DiseÃ±o responsive implementado** (mobile y desktop considerados)
- [ ] **Usado MCP de shadcn** para buscar componentes/ejemplos antes de implementar

---

## 19. TESTING CON CYPRESS

### Estructura

```
cypress/
â”œâ”€â”€ e2e/
â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”œâ”€â”€ sign-in.cy.ts
â”‚   â”‚   â””â”€â”€ sign-up.cy.ts
â”‚   â”œâ”€â”€ employees/
â”‚   â”‚   â”œâ”€â”€ list.cy.ts
â”‚   â”‚   â”œâ”€â”€ create.cy.ts
â”‚   â”‚   â””â”€â”€ edit.cy.ts
â”‚   â””â”€â”€ company/
â”‚       â””â”€â”€ unions.cy.ts
â”œâ”€â”€ fixtures/
â””â”€â”€ support/
```

### Template de Test

```typescript
describe('Employees Module', () => {
  beforeEach(() => {
    cy.login('admin@test.com', 'password');
    cy.visit('/employees');
  });

  it('should list employees', () => {
    cy.get('[data-testid="employees-table"]').should('exist');
  });

  it('should create employee', () => {
    cy.visit('/employees/new');
    cy.get('[data-testid="name"]').type('John Doe');
    cy.get('[data-testid="submit"]').click();
    cy.get('[data-testid="toast-success"]').should('be.visible');
  });
});
```

---

## RESUMEN DE ARQUITECTURA

### Pilares

1. **MÃ³dulos con Features**: Dominios de negocio â†’ sub-funcionalidades
2. **Route Groups**: `(auth)` + `(core)` en App Router
3. **Server Components First**: Fetching en servidor
4. **Shared para reutilizaciÃ³n**: UI, hooks, actions, lib
5. **No comunicaciÃ³n directa entre mÃ³dulos**: Usar shared/

### Estructura Resumida

```
src/
â”œâ”€â”€ app/           # Routing (pÃ¡ginas delgadas)
â”‚   â”œâ”€â”€ (auth)/    # Login, Register
â”‚   â””â”€â”€ (core)/    # Dashboard, Modules
â”œâ”€â”€ modules/       # LÃ³gica de negocio
â”‚   â”œâ”€â”€ {module}/
â”‚   â”‚   â”œâ”€â”€ features/
â”‚   â”‚   â”œâ”€â”€ actions.server.ts
â”‚   â”‚   â””â”€â”€ types.ts
â”œâ”€â”€ shared/        # CÃ³digo compartido
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ ui/
â”‚   â”‚   â””â”€â”€ layout/
â”‚   â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ actions/
â”‚   â””â”€â”€ lib/
â””â”€â”€ providers/     # React Context
```

---

## 20. STORAGE (MinIO/R2)

### Arquitectura

El sistema de storage es **unificado** y usa la API S3 para ambos entornos:

| Entorno | Servicio | Endpoint |
|---------|----------|----------|
| Desarrollo | MinIO (Docker) | `http://localhost:9000` |
| ProducciÃ³n | Cloudflare R2 | `https://<account>.r2.cloudflarestorage.com` |

**Mismo cÃ³digo para ambos** - Solo cambian las variables de entorno.

### ConfiguraciÃ³n

```env
# Proveedor: "s3" (recomendado) o "local" (legacy)
STORAGE_PROVIDER="s3"

# Credenciales S3 (MinIO o R2)
S3_ENDPOINT="http://localhost:9000"
S3_ACCESS_KEY="minioadmin"
S3_SECRET_KEY="minioadmin123"
S3_BUCKET="documents"
S3_REGION="us-east-1"
S3_FORCE_PATH_STYLE="true"  # true para MinIO, false para R2
```

### Comandos Docker

```bash
# Solo PostgreSQL (sin storage S3)
docker-compose up -d db

# PostgreSQL + MinIO (con storage S3)
docker-compose --profile storage up -d

# Ver logs de MinIO
docker-compose logs -f minio

# Parar todo
docker-compose --profile storage down
```

### Console de MinIO

Cuando MinIO estÃ¡ corriendo, acceder a la consola web:
- URL: `http://localhost:9001`
- Usuario: `minioadmin`
- Password: `minioadmin123`

### Uso en CÃ³digo

```typescript
// shared/lib/storage.ts
import {
  uploadFile,
  deleteFile,
  getPresignedDownloadUrl,
  getPresignedUploadUrl,
  validateFile,
  generateUniqueFilename,
} from '@/shared/lib/storage';

// Subir archivo
const result = await uploadFile(buffer, 'documento.pdf', {
  folder: 'empresa/empleados/juan-perez/dni',
});
// result = { key: '...', url: '...', filename: '...' }

// Obtener URL de descarga (presigned, expira en 1h)
const downloadUrl = await getPresignedDownloadUrl(key);

// Obtener URL de upload (para subida directa desde cliente)
const uploadUrl = await getPresignedUploadUrl(key, 'application/pdf');

// Eliminar archivo
await deleteFile(key);

// Validar archivo antes de subir
const validation = validateFile({
  size: file.size,
  type: file.type,
  name: file.name,
});
if (!validation.valid) {
  throw new Error(validation.error);
}
```

### Paths de Documentos

```typescript
import {
  generateEmployeeDocumentPath,
  generateEquipmentDocumentPath,
  generateCompanyDocumentPath,
  generateEmployeeSlug,
} from '@/shared/lib/storage';

// Genera: empresa-demo/empleados/juan-perez-12345678/dni/2024-01-15-dni.pdf
const path = generateEmployeeDocumentPath(
  'empresa-demo',           // companySlug
  'juan-perez-12345678',    // employeeSlug
  'dni',                    // documentTypeSlug
  '2024-01-15-dni.pdf'      // filename
);

// Helper para slug de empleado
const slug = generateEmployeeSlug('Juan', 'PÃ©rez', '12345678');
// â†’ "juan-perez-12345678"
```

### Archivos de ConfiguraciÃ³n

```
src/shared/
â”œâ”€â”€ config/
â”‚   â””â”€â”€ storage.config.ts   # ConfiguraciÃ³n centralizada
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ storage.ts          # API de storage
â””â”€â”€ ...
```

### LÃ­mites por Defecto

| LÃ­mite | Valor |
|--------|-------|
| TamaÃ±o mÃ¡ximo | 10 MB |
| Tipos permitidos | jpg, jpeg, png, webp, gif, pdf, doc, docx, xls, xlsx |
| ExpiraciÃ³n presigned URL | 1 hora (3600s) |

### ProducciÃ³n con Cloudflare R2

```env
# .env.production
STORAGE_PROVIDER="s3"
S3_ENDPOINT="https://<account-id>.r2.cloudflarestorage.com"
S3_ACCESS_KEY="<r2-access-key>"
S3_SECRET_KEY="<r2-secret-key>"
S3_BUCKET="documents"
S3_REGION="auto"
S3_FORCE_PATH_STYLE="false"
S3_PUBLIC_URL="https://files.tudominio.com"  # Opcional, para URLs pÃºblicas
```

---

**Este archivo es la fuente de verdad del proyecto. Seguir estas reglas garantiza cÃ³digo consistente, mantenible y de alta calidad.**
